<p>Il package javax.mail è molto ricco, quindi in prima istanza può anche disorientare, vedremo nel codice presentato in questo post quanto ripaghi in flessibilità e potenzialità questa complessità. E’ vero, non ho un metodo semplice mail() come in altri linguaggi,  ma ho gli strumenti per crearmi anche un server di posta di tutto rispetto (ma questo lo approfondieremo in un prossimo post, riguardo il semplice metodo mail() possiamo anche crearcelo a partire dalle API come vedremo e sarà fatto su misura per le nostre esigenze)
Per creare la nostra utility faremo riferimento al pattern commmand.
Per prima cosa definiamo una classe astratta che conterrà la gestione mailcap sempre utile quando si vuole gestire notifiche via mail da piattaforma Java.</p>

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">javax.activation.CommandMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.activation.MailcapCommandMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractMailCommand</span> <span class="o">{</span>

   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">mailcap</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">MailcapCommandMap</span> <span class="n">mc</span> <span class="o">=</span> <span class="o">(</span><span class="n">MailcapCommandMap</span><span class="o">)</span> <span class="n">CommandMap</span><span class="o">.</span><span class="na">getDefaultCommandMap</span><span class="o">();</span>
      <span class="n">mc</span><span class="o">.</span><span class="na">addMailcap</span><span class="o">(</span><span class="s">&quot;text/html;; x-java-content-handler=com.sun.mail.handlers.text_html&quot;</span><span class="o">);</span>
      <span class="n">mc</span><span class="o">.</span><span class="na">addMailcap</span><span class="o">(</span><span class="s">&quot;text/xml;; x-java-content-handler=com.sun.mail.handlers.text_xml&quot;</span><span class="o">);</span>
      <span class="n">mc</span><span class="o">.</span><span class="na">addMailcap</span><span class="o">(</span><span class="s">&quot;text/plain;; x-java-content-handler=com.sun.mail.handlers.text_plain&quot;</span><span class="o">);</span>
      <span class="n">mc</span><span class="o">.</span><span class="na">addMailcap</span><span class="o">(</span><span class="s">&quot;multipart/*;; x-java-content-handler=com.sun.mail.handlers.multipart_mixed&quot;</span><span class="o">);</span>
      <span class="n">mc</span><span class="o">.</span><span class="na">addMailcap</span><span class="o">(</span><span class="s">&quot;message/rfc822;; x-java-content-handler=com.sun.mail.handlers.message_rfc822&quot;</span><span class="o">);</span>
      <span class="n">CommandMap</span><span class="o">.</span><span class="na">setDefaultCommandMap</span><span class="o">(</span><span class="n">mc</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Segue a questo punto il codice della classe principale, la classe presenta metodi specifici per gestire anche l’invio di mail con autenticazione smtp.</p>

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Level</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.activation.DataHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.activation.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.activation.FileDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.BodyPart</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.MessagingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.Multipart</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.Session</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.Transport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.internet.AddressException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.internet.InternetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.internet.MimeBodyPart</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.internet.MimeMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.internet.MimeMultipart</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MailCommand</span> <span class="kd">extends</span> <span class="n">AbstractMailCommand</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> 
        <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MailCommand</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">smtp</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">user</span> <span class="o">=</span> <span class="s">&quot;myuser@domain.ext&quot;</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">from</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">body</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">debugEnabled</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">Session</span> <span class="n">session</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">MimeMessage</span> <span class="n">message</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;</span> <span class="n">attachments</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">MailCommand</span><span class="o">()</span> <span class="o">{</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="nf">MailCommand</span><span class="o">(</span><span class="n">String</span> <span class="n">smtp</span><span class="o">,</span> <span class="n">String</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">smtp</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">debugEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">mailcap</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addAttachment</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> 
    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
      <span class="n">BodyPart</span> <span class="n">messageBodyPart</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="n">messageBodyPart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeBodyPart</span><span class="o">();</span>
      <span class="n">DataSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDataSource</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
      <span class="n">messageBodyPart</span><span class="o">.</span><span class="na">setDataHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">DataHandler</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
      <span class="n">messageBodyPart</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">attachments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">messageBodyPart</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="n">initialize</span><span class="o">();</span> <span class="c1">//potevo usare il metodo con “base” se non mi interessa l’invio autenticato</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="n">MailCommandAuthenticator</span> <span class="n">authenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MailCommandAuthenticator</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">user</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">);</span>
      <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mail.smtp.host&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">smtp</span><span class="o">);</span>
      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mail.smtp.auth&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="n">authenticator</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">setDebug</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">debugEnabled</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">attachments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessage</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initializeBase</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mail.smtp.host&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">smtp</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">setDebug</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">debugEnabled</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">attachments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessage</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mail.smtp.host&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">smtp</span><span class="o">);</span>
      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;mail.smtp.auth&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span> <span class="o">=</span> <span class="n">session</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">setDebug</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">debugEnabled</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">attachments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessage</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">session</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFrom</span><span class="o">(</span><span class="n">String</span> <span class="n">from</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">setFrom</span><span class="o">(</span><span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">from</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTo</span><span class="o">(</span><span class="n">String</span> <span class="n">to</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">addRecipient</span><span class="o">(</span><span class="n">Message</span><span class="o">.</span><span class="na">RecipientType</span><span class="o">.</span><span class="na">TO</span><span class="o">,</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">to</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCc</span><span class="o">(</span><span class="n">String</span> <span class="n">cc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isNotEmpty</span><span class="o">(</span><span class="n">cc</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">addRecipient</span><span class="o">(</span><span class="n">Message</span><span class="o">.</span><span class="na">RecipientType</span><span class="o">.</span><span class="na">CC</span><span class="o">,</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">cc</span><span class="o">));</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBcc</span><span class="o">(</span><span class="n">String</span> <span class="n">bcc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AddressException</span><span class="o">,</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isNotEmpty</span><span class="o">(</span><span class="n">bcc</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">addRecipient</span><span class="o">(</span><span class="n">Message</span><span class="o">.</span><span class="na">RecipientType</span><span class="o">.</span><span class="na">BCC</span><span class="o">,</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">bcc</span><span class="o">));</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSubject</span><span class="o">(</span><span class="n">String</span> <span class="n">subject</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MessagingException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBody</span><span class="o">(</span><span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isNotEmpty</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">Multipart</span> <span class="n">multipart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMultipart</span><span class="o">();</span>
         <span class="n">BodyPart</span> <span class="n">messageBodyPart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeBodyPart</span><span class="o">();</span>
         <span class="n">messageBodyPart</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">body</span><span class="o">);</span>
         <span class="n">multipart</span><span class="o">.</span><span class="na">addBodyPart</span><span class="o">(</span><span class="n">messageBodyPart</span><span class="o">);</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">BodyPart</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">attachments</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>
            <span class="n">BodyPart</span> <span class="n">bodyPart</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">multipart</span><span class="o">.</span><span class="na">addBodyPart</span><span class="o">(</span><span class="n">bodyPart</span><span class="o">);</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">multipart</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">attachments</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">multipart</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="n">Transport</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getTransport</span><span class="o">(</span><span class="s">&quot;smtp&quot;</span><span class="o">);</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">FINEST</span><span class="o">,</span> <span class="s">&quot;Connect to host &quot;</span> <span class="o">+</span> <span class="n">smtp</span> <span class="o">+</span> <span class="s">&quot; from &quot;</span> <span class="o">+</span> <span class="n">from</span> <span class="o">+</span> <span class="s">&quot; password &#39;secret&#39;&quot;</span><span class="o">);</span>
         <span class="n">tr</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
         <span class="n">tr</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getAllRecipients</span><span class="o">());</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">FINEST</span><span class="o">,</span> <span class="s">&quot;Mail sent successfully&quot;</span><span class="o">);</span>
         <span class="n">tr</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MessagingException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Avrete notato la presenza di una classe <code>MailCommandAuthenticator</code> che serve proprio per la gestione dell’autenticazione al nostro server di posta.</p>

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">javax.mail.Authenticator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.mail.PasswordAuthentication</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MailCommandAuthenticator</span> <span class="kd">extends</span> <span class="n">Authenticator</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="n">String</span> <span class="n">user</span><span class="o">;</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">MailCommandAuthenticator</span><span class="o">(</span><span class="n">String</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="n">PasswordAuthentication</span> <span class="nf">getPasswordAuthentication</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">PasswordAuthentication</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">user</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>E’ ora non ci resta che mostrare un esempio di utilizzo, ma prima aiutiamoci con una classe che realizza il pattern <code>Singleton</code> </p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MailCommandInstantiator</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="n">MailCommand</span> <span class="n">instance</span><span class="o">;</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="n">MailCommand</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">String</span> <span class="n">smtp</span> <span class="o">=</span> <span class="s">&quot;smtp..myserver.ext&quot;</span><span class="o">;</span>
         <span class="n">String</span> <span class="n">user</span> <span class="o">=</span> <span class="s">&quot;auth@myserver.ext&quot;</span><span class="o">;</span>
         <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&quot;Secret&quot;</span><span class="o">;</span>
         <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MailCommand</span><span class="o">(</span><span class="n">smtp</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Ed ora il codice di chiamata, si tratta di uno degli esempi possibili atto ad illustrare la flessibilità del mini framework che abbiamo realizzato e che voi personalizzerete secondo le vostre esigenze.</p>

<div class="highlight"><pre><code class="java"><span class="n">MailCommand</span> <span class="n">mailCommand</span> <span class="o">=</span> <span class="n">MailCommandInstantiator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">setFrom</span><span class="o">(</span><span class="s">&quot;alice@myserver.ext&quot;</span><span class="o">);</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">addTo</span><span class="o">(</span><span class="s">&quot;bob@myserver.ext&quot;</span><span class="o">);</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">addCc</span><span class="o">(</span><span class="s">&quot;alice@myserver.ext&quot;</span><span class="o">);</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">addBcc</span><span class="o">(</span><span class="s">&quot;alice@myserver.ext&quot;</span><span class="o">);</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="s">&quot;The subject!&quot;</span><span class="o">);</span>
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">&quot;Body example.&quot;</span><span class="o">);</span>        
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">addAttachment</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/home/mailattach/attachment.pdf&quot;</span><span class="o">));</span>        
     <span class="n">mailCommand</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">//error management</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MessagingException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">//error management</span>
<span class="o">}</span></code></pre></div>

<p>Ovviamente posso aggiungere più allegati come è possibile o non aggiungerne affatto e quindi inviare solo tipiche mail di testo.</p>
